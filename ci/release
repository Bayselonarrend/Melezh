pipeline {
    agent {
        label 'windows'
    }
    parameters {
        string(name: 'VERSION', description: 'Image version (use "draft" for testing)', defaultValue: 'draft')
        string(name: 'MELEZH_VERSION', description: 'Melezh version', defaultValue: '0.6.0')
        string(name: 'OINT_VERSION', description: 'OInt version', defaultValue: '1.29.0')
        string(name: 'OINT_BUILD_ID', description: 'Jenkins OInt build ID', defaultValue: 'lastSuccessfulBuild')
        booleanParam(name: 'PUSH_TO_STABLE', description: 'Push to stable repo (melezh) instead of dev (melezh-dev)', defaultValue: false)
    }
    stages {
        stage('Release') {
            steps {
                bat encoding: 'UTF-8', script:'chcp 65001 & oscript ./ci/os/main.os'
                bat encoding: 'UTF-8', script:'chcp 65001 & oscript ./ci/os/releasemaker.os'
                script {
                    def melezhVersion = params.MELEZH_VERSION
                    archiveArtifacts artifacts: "${melezhVersion}/*"
                }
            }
        }

        stage('Update GIT') {
            steps {
                script {
                    withCredentials([gitUsernamePassword(credentialsId: 'gitmain', gitToolName: 'Default')]) {
                        bat "git config user.email vitaly.the.alpaca@gmail.com"
                        bat 'git config user.name "Vitaly the Alpaca (bot)"'
                        bat "git config --global core.ignorecase true"
                        bat "git add ."
                        bat 'git commit -m "Main build (Jenkins)"'
                        bat "git push origin HEAD:master"
                    }
                }
            }
        }
        
        stage('Build and Push Docker Images') {
            steps {
                script {
                    // Определяем целевой репозиторий
                    def targetRepo = params.PUSH_TO_STABLE ? "melezh" : "melezh-dev"
                    def pushLatest = params.PUSH_TO_STABLE
                    
                    // Создаем директорию для сборки в рабочей директории
                    bat """
                        if not exist "melezh-build\\en" mkdir "melezh-build\\en"
                        if not exist "melezh-build\\ru" mkdir "melezh-build\\ru"
                    """
                    
                    // Копируем локальные артефакты Melezh и скачиваем только OInt пакеты
                    copyLocalMelezhArtifacts(params.MELEZH_VERSION)
                    
                    withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
                        downloadOintPackages(params.OINT_BUILD_ID, params.OINT_VERSION)
                        
                        // Копируем файлы во все директории Docker заранее
                        copyFilesToDockerDirs()
                        
                        // Логин в GHCR
                        bat "echo %GITHUB_TOKEN% | docker login ghcr.io -u %USERNAME% --password-stdin"
                        
                        // Сборка и пушинг образов
                        buildAndPushImages(targetRepo, params.VERSION, pushLatest)
                    }
                }
            }
        }

        stage('Restart Docker Containers') {
            steps {
                script {
                    restartDockerContainers()
                }
            }
        }
    }
}

// Функция для копирования локальных артефактов Melezh
def copyLocalMelezhArtifacts(melezhVersion) {
    // English packages (deb)
    bat """
        copy "${melezhVersion}\\melezh_${melezhVersion}_all_en.deb" "melezh-build\\en\\melezh.deb"
        copy "${melezhVersion}\\melezh-${melezhVersion}-1.noarch_en.rpm" "melezh-build\\en\\melezh.rpm"
    """
    
    // Russian packages (deb & rpm)
    bat """
        copy "${melezhVersion}\\melezh_${melezhVersion}_all_ru.deb" "melezh-build\\ru\\melezh.deb"
        copy "${melezhVersion}\\melezh-${melezhVersion}-1.noarch_ru.rpm" "melezh-build\\ru\\melezh.rpm"
    """
}

// Функция для скачивания только OInt пакетов
def downloadOintPackages(ointBuildId, ointVersion) {
    // English packages (deb)
    bat """
        curl -L -o "melezh-build\\en\\oint.deb" ^
             "https://jenkins.openintegrations.dev/job/OpiBuild/job/OpiRelease/${ointBuildId}/artifact/${ointVersion}/oint_${ointVersion}_all_en.deb"
    """
    
    // Russian packages (deb)
    bat """
        curl -L -H "Authorization: Bearer %GITHUB_TOKEN%" ^
             -o "melezh-build\\ru\\oint.deb" ^
             "https://jenkins.openintegrations.dev/job/OpiBuild/job/OpiRelease/${ointBuildId}/artifact/${ointVersion}/oint_${ointVersion}_all_ru.deb"
    """
    
    // English packages (rpm)
    bat """
        curl -L -o "melezh-build\\en\\oint.rpm" ^
             "https://jenkins.openintegrations.dev/job/OpiBuild/job/OpiRelease/${ointBuildId}/artifact/${ointVersion}/oint-${ointVersion}-1.noarch_en.rpm"
    """
    
    // Russian packages (rpm)
    bat """
        curl -L -H "Authorization: Bearer %GITHUB_TOKEN%" ^
             -o "melezh-build\\ru\\oint.rpm" ^
             "https://jenkins.openintegrations.dev/job/OpiBuild/job/OpiRelease/${ointBuildId}/artifact/${ointVersion}/oint-${ointVersion}-1.noarch_ru.rpm"
    """
}

def copyFilesToDockerDirs() {
    // English DEB
    bat """
        copy "melezh-build\\en\\oint.deb" "service\\docker\\ghcr\\en-deb\\oint.deb"
        copy "melezh-build\\en\\melezh.deb" "service\\docker\\ghcr\\en-deb\\melezh.deb"
    """
    
    // Russian DEB
    bat """
        copy "melezh-build\\ru\\oint.deb" "service\\docker\\ghcr\\ru-deb\\oint.deb"
        copy "melezh-build\\ru\\melezh.deb" "service\\docker\\ghcr\\ru-deb\\melezh.deb"
    """
    
    // English RPM
    bat """
        copy "melezh-build\\en\\oint.rpm" "service\\docker\\ghcr\\en-rpm\\oint.rpm"
        copy "melezh-build\\en\\melezh.rpm" "service\\docker\\ghcr\\en-rpm\\melezh.rpm"
    """
    
    // Russian RPM
    bat """
        copy "melezh-build\\ru\\oint.rpm" "service\\docker\\ghcr\\ru-rpm\\oint.rpm"
        copy "melezh-build\\ru\\melezh.rpm" "service\\docker\\ghcr\\ru-rpm\\melezh.rpm"
    """
}

// Упрощенная функция сборки (теперь файлы уже на месте)
def buildAndPushImages(targetRepo, version, pushLatest) {
    // English DEB image
    bat """
        cd service\\docker\\ghcr\\en-deb
        docker build -t ghcr.io/bayselonarrend/${targetRepo}:${version}-deb-en .
        docker push ghcr.io/bayselonarrend/${targetRepo}:${version}-deb-en
    """
    
    if (pushLatest) {
        bat """
            docker tag ghcr.io/bayselonarrend/${targetRepo}:${version}-deb-en ^
                      ghcr.io/bayselonarrend/${targetRepo}:latest-deb-en
            docker push ghcr.io/bayselonarrend/${targetRepo}:latest-deb-en
        """
    }
    
    // Russian DEB image
    bat """
        cd service\\docker\\ghcr\\ru-deb
        docker build -t ghcr.io/bayselonarrend/${targetRepo}:${version}-deb-ru .
        docker push ghcr.io/bayselonarrend/${targetRepo}:${version}-deb-ru
    """
    
    if (pushLatest) {
        bat """
            docker tag ghcr.io/bayselonarrend/${targetRepo}:${version}-deb-ru ^
                      ghcr.io/bayselonarrend/${targetRepo}:latest-deb-ru
            docker push ghcr.io/bayselonarrend/${targetRepo}:latest-deb-ru
        """
    }
    
    // English RPM image
    bat """
        cd service\\docker\\ghcr\\en-rpm
        docker build -t ghcr.io/bayselonarrend/${targetRepo}:${version}-rpm-en .
        docker push ghcr.io/bayselonarrend/${targetRepo}:${version}-rpm-en
    """
    
    if (pushLatest) {
        bat """
            docker tag ghcr.io/bayselonarrend/${targetRepo}:${version}-rpm-en ^
                      ghcr.io/bayselonarrend/${targetRepo}:latest-rpm-en
            docker push ghcr.io/bayselonarrend/${targetRepo}:latest-rpm-en
        """
    }
    
    // Russian RPM image
    bat """
        cd service\\docker\\ghcr\\ru-rpm
        docker build -t ghcr.io/bayselonarrend/${targetRepo}:${version}-rpm-ru .
        docker push ghcr.io/bayselonarrend/${targetRepo}:${version}-rpm-ru
    """
    
    if (pushLatest) {
        bat """
            docker tag ghcr.io/bayselonarrend/${targetRepo}:${version}-rpm-ru ^
                      ghcr.io/bayselonarrend/${targetRepo}:latest-rpm-ru
            docker push ghcr.io/bayselonarrend/${targetRepo}:latest-rpm-ru
        """
    }
}

// Функция для перезапуска Docker контейнеров
def restartDockerContainers() {
    bat """
        cd service\\docker
        docker-compose down --remove-orphans
        docker system prune -f
        docker-compose up -d --force-recreate
    """
}