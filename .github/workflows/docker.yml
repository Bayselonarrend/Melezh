name: Build and Push Docker Images (Manual)

on:
  workflow_dispatch:
    inputs:
      oint_version:
        type: string
        description: 'Version of OInt, e.g. 1.24.0'
        required: true
      melezh_version:
        type: string
        description: 'Version of Melezh, e.g. 0.1.0'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create build directory
        run: |
          mkdir -p /tmp/melezh-build/{en,ru}

      - name: Download English DEB files from Draft Release (auth)
        run: |
          # Английские пакеты
          wget -H "Authorization: Bearer ${{ secrets.TOKEN }}" \
               -O /tmp/melezh-build/en/oint.deb \
               "https://github.com/Bayselonarrend/OpenIntegrations/releases/download/${{ github.event.inputs.oint_version }}/oint_${{ github.event.inputs.oint_version }}_all_en.deb"

          wget -H "Authorization: Bearer ${{ secrets.TOKEN }}" \
               -O /tmp/melezh-build/en/melezh.deb \
               "https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.melezh_version }}/melezh_${{ github.event.inputs.melezh_version }}_all_en.deb"

          # Русские пакеты
          wget -H "Authorization: Bearer ${{ secrets.TOKEN }}" \
               -O /tmp/melezh-build/ru/oint.deb \
               "https://github.com/Bayselonarrend/OpenIntegrations/releases/download/${{ github.event.inputs.oint_version }}/oint_${{ github.event.inputs.oint_version }}_all_en.deb"

          wget -H "Authorization: Bearer ${{ secrets.TOKEN }}" \
               -O /tmp/melezh-build/ru/melezh.deb \
               "https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.melezh_version }}/melezh_${{ github.event.inputs.melezh_version }}_all_ru.deb"

      - name: Log in to GHCR
        run: echo "${{ secrets.TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and Push English image
        run: |
          cd service/ghcr/en
          cp /tmp/melezh-build/en/oint.deb .
          cp /tmp/melezh-build/en/melezh.deb .
          docker build \
            -t ghcr.io/${{ github.actor }}/melezh:${{ github.event.inputs.melezh_version }}-en .
          docker push ghcr.io/${{ github.actor }}/melezh:${{ github.event.inputs.melezh_version }}-en

      - name: Build and Push Russian image
        run: |
          cd service/ghcr/ru
          cp /tmp/melezh-build/ru/oint.deb .
          cp /tmp/melezh-build/ru/melezh.deb .
          docker build \
            -t ghcr.io/${{ github.actor }}/melezh:${{ github.event.inputs.melezh_version }}-ru .
          docker push ghcr.io/${{ github.actor }}/melezh:${{ github.event.inputs.melezh_version }}-ru
