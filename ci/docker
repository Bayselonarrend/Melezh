pipeline {
    agent {
        label 'windows'
    }
    parameters {
        string(name: 'VERSION', description: 'Image version (use "draft" for testing)', defaultValue: 'draft')
        string(name: 'MELEZH_VERSION', description: 'Melezh version', defaultValue: '0.7.0')
        string(name: 'OINT_VERSION', description: 'OInt version', defaultValue: '1.30.0')
        string(name: 'OINT_BUILD_ID', description: 'Jenkins OInt build ID', defaultValue: 'lastSuccessfulBuild')
        booleanParam(name: 'PUSH_TO_STABLE', description: 'Push to stable repo (melezh) instead of dev (melezh-dev)', defaultValue: false)
    }
    stages {
        
        stage('Build and Push Docker Images') {
            steps {
                script {

                    def targetRepo = params.PUSH_TO_STABLE ? "melezh" : "melezh-dev"
                    def pushLatest = params.PUSH_TO_STABLE
                    
                    bat """
                        if not exist "melezh-build\\en" mkdir "melezh-build\\en"
                        if not exist "melezh-build\\ru" mkdir "melezh-build\\ru"
                    """
                    
                    copyLocalMelezhArtifacts(params.MELEZH_VERSION)
                    
                    withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
                        downloadOintPackages(params.OINT_BUILD_ID, params.OINT_VERSION)
                        
                        copyFilesToDockerDirs()
                        
                        bat "echo %GITHUB_TOKEN% | docker login ghcr.io -u %USERNAME% --password-stdin"
                        
                        buildAndPushImages(targetRepo, params.VERSION, pushLatest)
                    }
                }
            }
        }

    }
}

def copyLocalMelezhArtifacts(melezhVersion) {

    bat """
        copy "..\\MelezhRelease\\${melezhVersion}\\melezh_${melezhVersion}_all_en.deb" "melezh-build\\en\\melezh.deb"
        copy "..\\MelezhRelease\\${melezhVersion}\\melezh-${melezhVersion}-1.noarch_en.rpm" "melezh-build\\en\\melezh.rpm"
    """
    
    bat """
        copy "..\\MelezhRelease\\${melezhVersion}\\melezh_${melezhVersion}_all_ru.deb" "melezh-build\\ru\\melezh.deb"
        copy "..\\MelezhRelease\\${melezhVersion}\\melezh-${melezhVersion}-1.noarch_ru.rpm" "melezh-build\\ru\\melezh.rpm"
    """
}

def downloadOintPackages(ointBuildId, ointVersion) {

    bat """
        curl -L -o "melezh-build\\en\\oint.deb" ^
             "https://jenkins.openintegrations.dev/job/OpiBuild/job/OpiRelease/${ointBuildId}/artifact/${ointVersion}/oint_${ointVersion}_all_en.deb"
    """
    
    bat """
        curl -L -H "Authorization: Bearer %GITHUB_TOKEN%" ^
             -o "melezh-build\\ru\\oint.deb" ^
             "https://jenkins.openintegrations.dev/job/OpiBuild/job/OpiRelease/${ointBuildId}/artifact/${ointVersion}/oint_${ointVersion}_all_ru.deb"
    """
    
    bat """
        curl -L -o "melezh-build\\en\\oint.rpm" ^
             "https://jenkins.openintegrations.dev/job/OpiBuild/job/OpiRelease/${ointBuildId}/artifact/${ointVersion}/oint-${ointVersion}-1.noarch_en.rpm"
    """
    
    bat """
        curl -L -H "Authorization: Bearer %GITHUB_TOKEN%" ^
             -o "melezh-build\\ru\\oint.rpm" ^
             "https://jenkins.openintegrations.dev/job/OpiBuild/job/OpiRelease/${ointBuildId}/artifact/${ointVersion}/oint-${ointVersion}-1.noarch_ru.rpm"
    """
}

def copyFilesToDockerDirs() {

    bat """
        copy "melezh-build\\en\\oint.deb" "service\\docker\\ghcr\\en-deb\\oint.deb"
        copy "melezh-build\\en\\melezh.deb" "service\\docker\\ghcr\\en-deb\\melezh.deb"
    """
    
    bat """
        copy "melezh-build\\ru\\oint.deb" "service\\docker\\ghcr\\ru-deb\\oint.deb"
        copy "melezh-build\\ru\\melezh.deb" "service\\docker\\ghcr\\ru-deb\\melezh.deb"
    """
    
    bat """
        copy "melezh-build\\en\\oint.rpm" "service\\docker\\ghcr\\en-rpm\\oint.rpm"
        copy "melezh-build\\en\\melezh.rpm" "service\\docker\\ghcr\\en-rpm\\melezh.rpm"
    """
    
    bat """
        copy "melezh-build\\ru\\oint.rpm" "service\\docker\\ghcr\\ru-rpm\\oint.rpm"
        copy "melezh-build\\ru\\melezh.rpm" "service\\docker\\ghcr\\ru-rpm\\melezh.rpm"
    """
}

def buildAndPushImages(targetRepo, version, pushLatest) {

    bat """
        cd service\\docker\\ghcr\\en-deb
        docker build -t ghcr.io/bayselonarrend/${targetRepo}:${version}-deb-en .
        docker push ghcr.io/bayselonarrend/${targetRepo}:${version}-deb-en
    """
    
    if (pushLatest) {
        bat """
            docker tag ghcr.io/bayselonarrend/${targetRepo}:${version}-deb-en ^
                      ghcr.io/bayselonarrend/${targetRepo}:latest-deb-en
            docker push ghcr.io/bayselonarrend/${targetRepo}:latest-deb-en
        """
    }
    
    bat """
        cd service\\docker\\ghcr\\ru-deb
        docker build -t ghcr.io/bayselonarrend/${targetRepo}:${version}-deb-ru .
        docker push ghcr.io/bayselonarrend/${targetRepo}:${version}-deb-ru
    """
    
    if (pushLatest) {
        bat """
            docker tag ghcr.io/bayselonarrend/${targetRepo}:${version}-deb-ru ^
                      ghcr.io/bayselonarrend/${targetRepo}:latest-deb-ru
            docker push ghcr.io/bayselonarrend/${targetRepo}:latest-deb-ru
        """
    }
    
    bat """
        cd service\\docker\\ghcr\\en-rpm
        docker build -t ghcr.io/bayselonarrend/${targetRepo}:${version}-rpm-en .
        docker push ghcr.io/bayselonarrend/${targetRepo}:${version}-rpm-en
    """
    
    if (pushLatest) {
        bat """
            docker tag ghcr.io/bayselonarrend/${targetRepo}:${version}-rpm-en ^
                      ghcr.io/bayselonarrend/${targetRepo}:latest-rpm-en
            docker push ghcr.io/bayselonarrend/${targetRepo}:latest-rpm-en
        """
    }
    
    bat """
        cd service\\docker\\ghcr\\ru-rpm
        docker build -t ghcr.io/bayselonarrend/${targetRepo}:${version}-rpm-ru .
        docker push ghcr.io/bayselonarrend/${targetRepo}:${version}-rpm-ru
    """
    
    if (pushLatest) {
        bat """
            docker tag ghcr.io/bayselonarrend/${targetRepo}:${version}-rpm-ru ^
                      ghcr.io/bayselonarrend/${targetRepo}:latest-rpm-ru
            docker push ghcr.io/bayselonarrend/${targetRepo}:latest-rpm-ru
        """
    }
}
