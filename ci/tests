pipeline {
	agent {
		label 'windows'
	}
    stages {

        stage('Restart Docker Containers') {
            steps {
                script {
                    restartDockerContainers()
                }
            }
        }

        stage('CLI Test (RU)') {
            steps {
                    bat encoding: 'UTF-8', script:'chcp 65001 & oneunit e -f ./tests/tests_ru.os'
            }
        }

        stage('CLI Test (EN)') {
            steps {
                    bat encoding: 'UTF-8', script:'chcp 65001 & oneunit e -f ./tests/tests_en.os'
            }
        }

        stage('Requests Test (RU)') {
            steps {
                    bat encoding: 'UTF-8', script:'chcp 65001 & oneunit e -f ./tests/tests_handlers_ru.os'
            }
        }

        stage('Main UI Tests (RPM, RU)') {
            steps {
                bat 'npm install -g @seleniumhq/side-runner'
                bat 'selenium-side-runner ./tests/selenium/tests.side --base-url http://localhost:1921 --browser chrome'
            }
        }
    }
}

def restartDockerContainers() {
    bat """
        cd service\\docker
        docker-compose down --remove-orphans
        docker system prune -f
        docker-compose up -d --force-recreate
    """
}